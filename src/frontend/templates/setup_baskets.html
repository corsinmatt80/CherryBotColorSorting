<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Baskets</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>Set Baskets</h1>
    <p>Adjust the basket positions if needed by dragging on the canvas. Then click "Accept" or "Adjust".</p>
    
    <div>
        <canvas id="basketsCanvas"></canvas>
    </div>
    <button id="acceptButton">Accept</button>
    <button id="adjustButton">Adjust</button>

    <script>
        const imagePath = "{{ image_path }}";
        const detectedSquares = JSON.parse('{{ squares|tojson|escapejs }}');

        const canvas = document.getElementById("basketsCanvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();

        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            drawSquares(detectedSquares);
        };

        img.src = imagePath;

        function drawSquares(squares) {
            ctx.strokeStyle = "red";
            ctx.lineWidth = 2;
            squares.forEach(square => {
                const [x, y, w, h] = square;
                ctx.strokeRect(x, y, w, h);
            });
        }

        canvas.addEventListener("mousedown", onMouseDown);
        canvas.addEventListener("mouseup", onMouseUp);

        let isDragging = false;
        let currentSquare = null;

        function onMouseDown(event) {
            const rect = canvas.getBoundingClientRect();
            const mouseX = event.clientX - rect.left;
            const mouseY = event.clientY - rect.top;

            // Check if user clicked inside a square
            currentSquare = detectedSquares.find(([x, y, w, h]) =>
                mouseX > x && mouseX < x + w && mouseY > y && mouseY < y + h
            );

            if (currentSquare) {
                isDragging = true;
            }
        }

        function onMouseUp(event) {
            if (isDragging && currentSquare) {
                const rect = canvas.getBoundingClientRect();
                const mouseX = event.clientX - rect.left;
                const mouseY = event.clientY - rect.top;

                // Update square position
                const [x, y, w, h] = currentSquare;
                currentSquare[0] = mouseX - w / 2;
                currentSquare[1] = mouseY - h / 2;

                // Redraw canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                drawSquares(detectedSquares);

                isDragging = false;
                currentSquare = null;
            }
        }

        // Handle Accept and Adjust buttons
        document.getElementById("acceptButton").addEventListener("click", () => {
            fetch("/setup_baskets", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ action: "accept" }),
            }).then(response => response.json())
              .then(data => alert(data.status));
        });

        document.getElementById("adjustButton").addEventListener("click", () => {
            fetch("/setup_baskets", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    action: "adjust",
                    baskets: detectedSquares,
                }),
            }).then(response => response.json())
              .then(data => alert(data.status));
        });
    </script>
</body>
</html>
